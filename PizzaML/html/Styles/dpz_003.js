define("dpz.hotspots",["simplr","dpz.config","dpz.kiosk","dpz.easyOrder"],function(a,b,c,d){function e(a){site.storage.save("hotspots",a)}function f(){return m=!0,$.when(m)}function g(a){return a&&a.PostalCode&&a.PostalCode.length>0}function h(){var a=dpz.util.cookies.getItem("geolocationPermission");return"true"===a||"false"===a}function i(a){return jsDPZ.ajax.getHotspotsByIP(a).then(function(a){return!!a.Hotspots&&!!a.Hotspots.length})}function j(a,b){return b.timeout=5e3,jsDPZ.ajax.getHotspotsByAddress($.extend(!0,{address:a},b)).then(function(a){return!!a.Hotspots&&!!a.Hotspots.length})}var k,l,m,n=function(a){return a.ServiceIsOpen};return!killConfig.isMarketEnabled("hotspots")||c.isActive?{isActive:function(){return!1},init:function(){return $.when(!1)},isHotspotOrder:function(){return!1}}:k={radius:.16,cacheLocation:function(a){var b=$.extend({},a.coords),c=$.extend({},a,{coords:b});return jsDPZ.app.customer.getCustomer().data.Session.cachedPosition=c,site.sessionTools.save()},clearHotspot:function(){delete jsDPZ.app.order.getOrder().data.DeliveryHotspot,delete jsDPZ.app.order.getOrder().data.Customer.Address,site.sessionTools.save()},isActive:function(){return jsDPZ.app.customer.getCustomer().data.Session.hotspotsIsActive=!d.isInEasyOrderFlow()&&!0!==m&&"true"===site.storage.load("hotspots"),!0!==m&&"true"===site.storage.load("hotspots")},getHotspots:function(a,b,c){var d=$.extend({distanceCoordinates:b},a);return c&&(d.radius=c),jsDPZ.ajax.getHotspotsByGPSCoords(d).then(function(a){return a.Hotspots=a.Hotspots.filter(n),a})},addressInHotspotsArea:function(a){return j(a,{radius:k.radius,maxResults:1})},getLocatorPermission:function(){return dpz.util.cookies.getItem("geolocationPermission")},getUserLocation:function(a){var b=a&&a.highAccuracyTimeout||3e3,c=a&&a.lowAccuracyTimeout||7e3,d=a&&a.maximumAge||0,e=$.Deferred(function(a){var e=function(b){k.cacheLocation(b).then(function(){a.resolve(b)})},f=function(){navigator.geolocation.getCurrentPosition(e,a.reject,{enableHighAccuracy:!1,timeout:c,maximumAge:d})};navigator.geolocation.getCurrentPosition(e,f,{enableHighAccuracy:!0,timeout:b,maximumAge:d})});return{cached:jsDPZ.app.customer.getCustomer().data.Session.cachedPosition?jsDPZ.app.customer.getCustomer().data.Session.cachedPosition:e,current:e}},isHotspotOrder:function(a){return k.isActive()&&!!(a&&a.DeliveryHotspot&&a.DeliveryHotspot.Id)},setLocatorPermission:function(a){dpz.util.cookies.setItem("geolocationPermission",a)},autoLocateHotspotStore:function(b){jsDPZ.ajax.storeProfile(b).then(function(c){var d=jsDPZ.app.customer.getCustomer().getSessionData();c.Address={City:c.City,PostalCode:c.PostalCode,Region:c.Region,Street:c.Street,StreetName:c.StreetName,UnitNumber:c.UnitNumber,UnitType:c.UnitType},d.Address={Coordinates:{Latitude:b.Latitude,Longitude:b.Longitude},Name:b.Name,Description:b.Description},d.StoreID=c.StoreID,delete jsDPZ.app.order.getOrder().data.Customer.Address,jsDPZ.app.order.getOrder().data.Customer.Address={Coordinates:{Latitude:b.Latitude,Longitude:b.Longitude}},jsDPZ.app.store.setStore(c),$.extend(!0,jsDPZ.app.order.getOrder().data,{DeliveryHotspot:b},{Notifications:{}}),site.sessionTools.save().then(a.controller.mRouteAndExecute(site.func.buildURL({url:"#/locate/",parameters:{StoreID:b.StoreID,type:"Delivery",latitude:b.Latitude,longitude:b.Longitude,hotspot:!0}})))}).fail(function(){site.func.powerCommunicationError()})},init:function(){var a,b={maxResults:1,radius:k.radius};return l||(a=null!==site.storage.load("hotspots")?$.when(this.isActive()):h()?$.when(h()):g(jsDPZ.app.order.getOrder().data.Customer.Address)?j(jsDPZ.app.order.getOrder().data.Customer.Address,b):g(jsDPZ.app.store.getStore().data.Address)?j(jsDPZ.app.store.getStore().data.Address,b):i(b),l=a.then(e).then(k.isActive).catch(function(){l=$.when(f())}))}}});